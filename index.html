<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Function Compatibility Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS library for reading and writing Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-upload-label {
             display: flex;
             flex-direction: column;
             align-items: center;
             justify-content: center;
             width: 100%;
             height: 12rem; /* 192px */
             border: 2px dashed #d1d5db;
             border-radius: 0.5rem;
             cursor: pointer;
             background-color: #f9fafb;
             transition: background-color 0.2s;
        }
        .file-upload-label:hover {
            background-color: #f3f4f6;
        }
        .table-cell {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            font-size: 0.875rem;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .table-header {
            background-color: #f8fafc;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-5xl">
        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Function Compatibility Tool</h1>
            <p class="mt-2 text-lg text-gray-600">Highlight or wrap incompatible functions between Excel and Google Sheets.</p>
        </header>

        <!-- Main Application Card -->
        <div class="bg-white rounded-xl shadow-lg p-6 sm:p-8 border border-gray-200">
            
            <!-- Step 1: Upload Spreadsheet -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">1. Upload your spreadsheet</h2>
                <label for="file-upload" class="file-upload-label">
                    <div class="text-center p-6">
                        <svg class="w-10 h-10 mb-4 text-gray-500 mx-auto" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                        <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                        <p class="text-xs text-gray-500">XLSX file</p>
                    </div>
                    <input id="file-upload" type="file" class="hidden" accept=".xlsx"/>
                </label>
                <p id="file-name" class="mt-2 text-center text-sm text-gray-500"></p>
            </div>
            
            <!-- Step 2: Choose Action -->
            <div class="mb-6">
                 <h2 class="text-xl font-semibold text-gray-700 mb-3">2. Choose an action</h2>
                 <fieldset class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <label for="action-highlight" class="flex items-center p-4 border border-gray-300 rounded-lg cursor-pointer hover:bg-red-50 hover:border-red-400 transition-all">
                        <input type="radio" id="action-highlight" name="action-type" value="highlight" class="h-5 w-5 text-red-600 border-gray-300 focus:ring-red-500" checked>
                        <span class="ml-3 text-md font-medium text-gray-700">Highlight Functions</span>
                    </label>
                    <label for="action-wrap-excel" class="flex items-center p-4 border border-gray-300 rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-400 transition-all">
                        <input type="radio" id="action-wrap-excel" name="action-type" value="wrap-excel" class="h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500">
                        <span class="ml-3 text-md font-medium text-gray-700">Wrap for Excel (UDF)</span>
                    </label>
                    <label for="action-wrap-gsheets" class="flex items-center p-4 border border-gray-300 rounded-lg cursor-pointer hover:bg-green-50 hover:border-green-400 transition-all">
                        <input type="radio" id="action-wrap-gsheets" name="action-type" value="wrap-gsheets" class="h-5 w-5 text-green-600 border-gray-300 focus:ring-green-500">
                        <span class="ml-3 text-md font-medium text-gray-700">Replace with Value (for GSheets)</span>
                    </label>
                </fieldset>
            </div>

            <!-- Step 3: Provide Functions to Find -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">3. List of functions to target</h2>
                <label for="functions-list" class="block text-sm font-medium text-gray-600 mb-2">These functions will be targeted by the action above. One per line.</label>
                <textarea id="functions-list" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 font-mono text-sm">ADD
AMORDEGRC
ARRAY_CONSTRAIN
ARRAYFORMULA
AVERAGE.WEIGHTED
BINOM.DIST.RANGE
CALL
COUNTUNIQUE
CUBEKPIMEMBER
CUBEMEMBER
CUBEMEMBERPROPERTY
CUBERANKEDMEMBER
CUBESET
CUBESETCOUNT
CUBEVALUE
DBCS
DETECTLANGUAGE
DIVIDE
EPOCHTODATE
EQ
EUROCONVERT
EXPAND
FILTERXML
FORECAST.ETS
FORECAST.ETS.CONFINT
FORECAST.ETS.SEASONALITY
FORECAST.ETS.STAT
GOOGLETRANSLATE
GROUPBY
INFO
ISBETWEEN
ISDATE
ISEMAIL
ISOMITTED
ISURL
JIS
LET
MARGINOFERROR
MINUS
MULTIPLY
NUMBERVALUE
ODDFPRICE
ODDFYIELD
ODDLPRICE
ODDLYIELD
PERCENTOF
PHONETIC
PIVOTBY
POW
QUERY
REGISTER.ID
RTD
SHEET
SHEETS
SORTN
SPARKLINE
STOCKHISTORY
TAKE
TEXTAFTER
TEXTBEFORE
TEXTSPLIT
TO_DATE
TO_DOLLARS
TO_PERCENT
TO_PURE_NUMBER
TO_TEXT
TRIMRANGE
UMINUS
UNARY_PERCENT
UPLUS
VALUETOTEXT
WEBSERVICE
WRAPCOLS
WRAPROWS</textarea>
            </div>

            <!-- Step 4: Process -->
            <div class="text-center">
                 <button id="process-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    Find & Highlight
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-container" class="mt-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Results</h2>
            <div id="results-output" class="bg-white rounded-xl shadow-lg border border-gray-200 p-6 overflow-x-auto">
                <!-- Results will be injected here -->
            </div>
            <div id="download-section" class="text-center p-4 mt-4 hidden">
                <button id="download-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all">Download Modified File</button>
            </div>
        </div>
        
    </div>

    <script>
        // --- DOM Element References ---
        const fileUpload = document.getElementById('file-upload');
        const fileNameDisplay = document.getElementById('file-name');
        const functionsListInput = document.getElementById('functions-list');
        const processBtn = document.getElementById('process-btn');
        const resultsContainer = document.getElementById('results-container');
        const resultsOutput = document.getElementById('results-output');
        const downloadSection = document.getElementById('download-section');
        const downloadBtn = document.getElementById('download-btn');
        const actionRadios = document.querySelectorAll('input[name="action-type"]');

        let originalWorkbook = null;
        let modifiedWorkbook = null;

        // --- Event Listeners ---
        fileUpload.addEventListener('change', handleFile, false);
        processBtn.addEventListener('click', processFile, false);
        downloadBtn.addEventListener('click', downloadModifiedFile, false);
        actionRadios.forEach(radio => radio.addEventListener('change', updateButtonText));

        /**
         * Updates the main button text based on the selected action.
         */
        function updateButtonText() {
            const selectedAction = document.querySelector('input[name="action-type"]:checked').value;
            if (selectedAction === 'highlight') {
                processBtn.textContent = 'Find & Highlight';
            } else if (selectedAction === 'wrap-excel') {
                processBtn.textContent = 'Wrap for Excel';
            } else { // wrap-gsheets
                processBtn.textContent = 'Replace with Value';
            }
        }

        /**
         * Handles the file upload event.
         */
        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                originalWorkbook = XLSX.read(data, { type: 'array', cellFormula: true, cellStyles: true });
                fileNameDisplay.textContent = `Selected file: ${file.name}`;
                processBtn.disabled = false;
            };
            reader.readAsArrayBuffer(file);
        }

        /**
         * Main function to process the spreadsheet based on the selected action.
         */
        function processFile() {
            if (!originalWorkbook) {
                alert("Please upload a spreadsheet first.");
                return;
            }

            const functionsToFind = functionsListInput.value
                .split('\n')
                .map(f => f.trim().toUpperCase())
                .filter(f => f.length > 0);

            if (functionsToFind.length === 0) {
                alert("Please provide a list of functions to target.");
                return;
            }

            const selectedAction = document.querySelector('input[name="action-type"]:checked').value;
            
            modifiedWorkbook = JSON.parse(JSON.stringify(originalWorkbook));
            
            const functionRegex = new RegExp('\\b(' + functionsToFind.join('|') + ')\\(', 'i');
            let processedItems = [];

            modifiedWorkbook.SheetNames.forEach(sheetName => {
                const worksheet = modifiedWorkbook.Sheets[sheetName];
                for (const cellAddress in worksheet) {
                    const cell = worksheet[cellAddress];
                    if (cell.f && functionRegex.test(cell.f)) {
                        const originalFormula = cell.f;
                        const originalValue = originalWorkbook.Sheets[sheetName][cellAddress]?.v;

                        if (selectedAction === 'highlight') {
                            const redFillStyle = { fill: { patternType: "solid", fgColor: { rgb: "FFFF0000" } } };
                            cell.s = { ...cell.s, ...redFillStyle };
                            processedItems.push(`${sheetName}!${cellAddress}`);
                        
                        } else if (selectedAction === 'wrap-excel') {
                            let fallbackValue;
                            if (originalValue === undefined || originalValue === null) fallbackValue = '""';
                            else if (typeof originalValue === 'string') fallbackValue = `"${originalValue.replace(/"/g, '""')}"`;
                            else if (typeof originalValue === 'number' || typeof originalValue === 'boolean') fallbackValue = originalValue;
                            else fallbackValue = '"#VALUE!"';
                            
                            const escapedFormula = originalFormula.replace(/"/g, '""');
                            const newFormula = `=IFERROR(__xludf.DUMMYFUNCTION("${escapedFormula}"), ${fallbackValue})`;
                            
                            cell.f = newFormula;
                            delete cell.v; 
                            processedItems.push({ sheet: sheetName, cell: cellAddress, original: originalFormula, converted: newFormula });
                        
                        } else { // wrap-gsheets: Replace with static value and add comment
                            // 1. Remove the formula
                            delete cell.f;

                            // 2. Set the static value and type
                            cell.v = originalValue;
                            if (typeof originalValue === 'string') cell.t = 's';
                            else if (typeof originalValue === 'number') cell.t = 'n';
                            else if (typeof originalValue === 'boolean') cell.t = 'b';
                            else if (originalValue instanceof Date) cell.t = 'd';
                            else { // If value is undefined or null, make it an empty string cell
                                cell.v = "";
                                cell.t = 's';
                            }
                            
                            // 3. Add the original formula as a comment
                            if (!cell.c) cell.c = [];
                            cell.c.push({a: "Converter", t: originalFormula});

                            processedItems.push({ sheet: sheetName, cell: cellAddress, original: originalFormula, converted: `Value: ${cell.v} (Formula moved to comment)` });
                        }
                    }
                }
            });

            displayResults(processedItems, selectedAction);
        }
        
        /**
         * Shows the results section.
         */
        function displayResults(items, action) {
            resultsContainer.classList.remove('hidden');
            
            if (items.length > 0) {
                if (action === 'highlight') {
                    resultsOutput.innerHTML = `<p class="font-semibold mb-2">Found and highlighted ${items.length} cell(s):</p>
                                               <ul class="list-disc list-inside text-gray-600 font-mono text-sm">${items.map(c => `<li>${c}</li>`).join('')}</ul>`;
                } else { // wrap-excel or wrap-gsheets
                    let tableHtml = `<p class="font-semibold mb-2">Processed ${items.length} formula(s):</p>
                                     <table class="w-full text-left">
                                       <thead><tr>
                                         <th class="table-cell table-header">Cell</th>
                                         <th class="table-cell table-header">Original Formula</th>
                                         <th class="table-cell table-header">Action Taken</th>
                                       </tr></thead><tbody>`;
                    items.forEach(item => {
                        tableHtml += `<tr>
                                        <td class="table-cell font-mono">${item.sheet}!${item.cell}</td>
                                        <td class="table-cell font-mono">${item.original}</td>
                                        <td class="table-cell font-mono">${item.converted}</td>
                                      </tr>`;
                    });
                    tableHtml += `</tbody></table>`;
                    resultsOutput.innerHTML = tableHtml;
                }
                downloadSection.classList.remove('hidden');
            } else {
                resultsOutput.innerHTML = `<p class="text-gray-600">No cells found containing the specified functions.</p>`;
                downloadSection.classList.add('hidden');
            }
            
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * Triggers the download of the modified .xlsx file.
         */
        function downloadModifiedFile() {
            if (modifiedWorkbook) {
                XLSX.writeFile(modifiedWorkbook, "modified_file.xlsx", {cellStyles: true});
            } else {
                alert("No modified file is available. Please process a file first.");
            }
        }
    </script>
</body>
</html>
